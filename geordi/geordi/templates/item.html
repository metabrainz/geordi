{% extends "layout.html" %}
{% from "map_rendering.html" import render_map %}
{% block title %}Item {{ item.id }}{% endblock %}
{% block content %}
  {%- if current_user.id -%}
    <button class="btn btn-primary btn-lg pull-right match-modal-button"
      data-toggle="modal"
      data-target="#match-modal"
      data-item-type="{{ item.type }}"
      data-item-id="{{ item.id }}">Match this item</button>
    <button class="btn btn-primary btn-lg pull-right import-modal-button"
      data-toggle="modal"
      data-target="#import-modal"
      data-item-type="{{ item.type }}"
      data-item-id="{{ item.id }}">Import this item</button>
  {%- endif -%}

  <h2>Mapped Data</h2>
  {{ render_map(item) }}

  <p class="lead"><a href="{{ url_for('frontend.item_links', item_id=item.id) }}">View linked items</a></p>

  <h2>Raw Data</h2>
  <ul style="list-style-type: none; padding: 0">
    {% for id, data in item.data_formatted.iteritems() %}
      <li><h3>{{ id }}</h3>{% highlight 'json' %}{{ data }}{% endhighlight %}</li>
    {% endfor %}
    <li><h3>Raw item map</h3>{%- highlight 'json' %}{{ item.map_formatted }}{% endhighlight -%}</li>
  </ul>
{% endblock %}

{%- if current_user.id -%}
  {% block hiddencontent %}
    <div class="modal" id="match-modal" tabindex="-1" role="dialog" aria-labelledby="match-modal-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="match-modal-label">Match this item to MusicBrainz</h4>
          </div>
          <div class="modal-body" data-bind="with: currentItem">
            <matching-form params="type: type, id: id"></matching-form>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="import-modal" tabindex="-1" role="dialog" aria-labelledby="import-modal-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title" id="import-modal-label">Import this item into MusicBrainz</h4>
          </div>
          <div class="modal-body">
            {%- if item.map.release -%}
              <form action="https://musicbrainz.org/release/add" method="post">
                <input type="hidden" name="name" value="{{ item.map.release.name[0] }}">
                {%- if item.map.release.artists.combined -%}
                  {%- for artist in item.map.release.artists.combined -%}
                    <input type="hidden" name="artist_credit.names.{{ loop.index0 }}.artist.name" value="{{ artist.name }}">
                    <input type="hidden" name="artist_credit.names.{{ loop.index0 }}.name" value="{{ artist.credit }}">
                    <input type="hidden" name="artist_credit.names.{{ loop.index0 }}.join_phrase" value="{{ artist.join_phrase }}">
                  {% endfor %}
                {%- elif item.map.release.artists.split -%}
                  {%- for name in item.map.release.artists.split.names -%}
                    <input type="hidden" name="artist_credit.names.{{ loop.index0 }}.artist.name" value="{{ name }}">
                  {% endfor %}
                {%- elif item.map.release.artists.unsplit -%}
                  <input type="hidden" name="artist_credit.names.0.artist.name" value="{{ item.map.release.artists.unsplit.name[0] }}">
                {%- endif -%}
                {%- if item.map.release.events.combined -%}
                  {%- for event in item.map.release.events.combined -%}
                    <input type="hidden" name="events.{{ loop.index0 }}.country" value="{{ event.country }}">
                    {# REQUIRES SPLITTING DATE #}
                    <input type="hidden" name="events.{{ loop.index0 }}.date.year" value="">
                    <input type="hidden" name="events.{{ loop.index0 }}.date.month" value="">
                    <input type="hidden" name="events.{{ loop.index0 }}.date.day" value="">
                  {% endfor %}
                {%- elif item.map.release.events.split and not item.map.release.events.split.dates -%}
                  {%- for country in item.map.release.events.split.countries -%}
                    <input type="hidden" name="events.{{ loop.index0 }}.country" value="{{ country }}">
                  {% endfor %}
                {%- elif item.map.release.events.split and not item.map.release.events.split.countries -%}
                  {%- for date in item.map.release.events.split.dates -%}
                    {# REQUIRES SPLITTING DATE #}
                    <input type="hidden" name="events.{{ loop.index0 }}.date.year" value="">
                    <input type="hidden" name="events.{{ loop.index0 }}.date.month" value="">
                    <input type="hidden" name="events.{{ loop.index0 }}.date.day" value="">
                  {% endfor %}
                {%- elif item.map.release.events.split -%} 
                  {# REQUIRES UI #}
                {%- endif -%}
                {%- if item.map.release.labels.combined -%}
                  {%- for label in item.map.release.labels.combined -%}
                    <input type="hidden" name="labels.{{ loop.index0 }}.name" value="{{ label.label }}">
                    <input type="hidden" name="labels.{{ loop.index0 }}.catalog_number" value="{{ label.catalog_number }}">
                  {% endfor %}
                {%- elif item.map.release.labels.split -%}
                  {# REQUIRES UI #}
                {%- endif -%}
                <input type="hidden" name="barcode" value="{{ item.map.release.barcode[0] }}"> {# REQUIRES UI TO SUPPORT MULTIPLE BARCODES #}

                {%- if item.map.release.mediums.combined -%}
                  {%- for medium in item.map.release.mediums.combined if medium.tracks -%}
                    {% set medium_loop = loop %}
                    {%- if medium.format -%}
                      <input type="hidden" name="mediums.{{ loop.index0 }}.format" value="{{ medium.format }}">
                    {%- endif -%}
                    {%- for track in medium.tracks -%}
                      {% set track_loop = loop %}
                      {%- if track.name -%}
                        <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ loop.index0 }}.name" value="{{ track.name[0] }}">
                      {%- endif -%}
                      {%- if track.length -%}
                        <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ loop.index0 }}.length" value="{{ track.length[0] }}">
                      {%- endif -%}
                      {%- if track.number -%}
                        <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ loop.index0 }}.number" value="{{ track.number[0] }}">
                      {%- endif -%}
                      {%- if track.artists.combined -%}
                        {%- for artist in track.artists.combined -%}
                          <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.artist.name" value="{{ artist.name }}">
                          <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.name" value="{{ artist.credit }}">
                          <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.join_phrase" value="{{ artist.join_phrase }}">
                        {% endfor %}
                      {%- elif track.artists.split -%}
                        {%- for name in track.artists.split.names -%}
                          <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.artist.name" value="{{ name }}">
                        {% endfor %}
                      {%- elif track.artists.unsplit -%}
                        <input type="hidden" name="mediums.{{ medium_loop.index0 }}.track.{{ track_loop.index0 }}.artist_credit.names.0.artist.name" value="{{ track.artists.unsplit.name[0] }}">
                      {%- endif -%}
                    {% endfor %}
                  {% endfor %}
                {%- elif item.map.release.mediums.split and item.map.release.mediums.split.tracks -%}
                  {%- if item.map.release.mediums.split.format -%}
                    <input type="hidden" name="mediums.0.format" value="{{ item.map.release.mediums.split.format[0] }}">
                  {%- endif -%}
                  {%- for track in item.map.release.mediums.split.tracks -%}
                    {% set track_loop = loop %}
                    {%- if track.name -%}
                      <input type="hidden" name="mediums.0.track.{{ loop.index0 }}.name" value="{{ track.name[0] }}">
                    {%- endif -%}
                    {%- if track.length -%}
                      <input type="hidden" name="mediums.0.track.{{ loop.index0 }}.length" value="{{ track.length[0] }}">
                    {%- endif -%}
                    {%- if track.number -%}
                      <input type="hidden" name="mediums.0.track.{{ loop.index0 }}.number" value="{{ track.number[0] }}">
                    {%- endif -%}
                    {%- if track.artists.combined -%}
                      {%- for artist in track.artists.combined -%}
                        <input type="hidden" name="mediums.0.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.artist.name" value="{{ artist.name }}">
                        <input type="hidden" name="mediums.0.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.name" value="{{ artist.credit }}">
                        <input type="hidden" name="mediums.0.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.join_phrase" value="{{ artist.join_phrase }}">
                      {% endfor %}
                    {%- elif track.artists.split -%}
                      {%- for name in track.artists.split.names -%}
                        <input type="hidden" name="mediums.0.track.{{ track_loop.index0 }}.artist_credit.names.{{ loop.index0 }}.artist.name" value="{{ name }}">
                      {% endfor %}
                    {%- elif track.artists.unsplit -%}
                      <input type="hidden" name="mediums.0.track.{{ track_loop.index0 }}.artist_credit.names.0.artist.name" value="{{ track.artists.unsplit.name[0] }}">
                    {%- endif -%}
                  {% endfor %}
                {%- endif -%}
                <input type="submit" value="Import">
              </form>
            {%- endif -%}
          </div>
        </div>
      </div>
    </div>
  {% endblock %}
  {%- block js %}
    {{ super() }}
    <script>require(["matching"]);</script>
  {% endblock -%}
{%- endif -%}
